<!doctype html>
<html lang="">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Laika 1.0.0" />
    <title>Parallelism and Concurrency</title>
    
    
    <meta name="description" content="docs" />
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400|Source+Sans+Pro:300,400,600"
        rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Crimson+Pro:400" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="../css/creative-scala.css" />
    <script src="../js/toc.js"></script><script src="../js/solution.js"></script><script src="../main.js"></script>
    <script> /* for avoiding page load transitions */</script>
</head>

<body>
    <nav id="topbar">
      <details>
        <summary>Cats Effect Tutorial</summary>
        <ul class="nav-list">
          <li class="level1 nav-node"><a href="../introduction/">Introduction</a></li>
          <li class="level2 nav-leaf"><a href="../introduction/clock.html">Clock</a></li>
          <li class="level1 active nav-node"><a href="#">Parallelism and Concurrency</a></li>
          <li class="level2 nav-leaf"><a href="coordination.html">Concurrent Coordination</a></li>
          <li class="level2 nav-leaf"><a href="job-manager.html">Job Manager</a></li>
        </ul>
      </details>
    </nav>
    <nav id="sidebar">
        <ul class="nav-list">
          <li class="level1 nav-leaf"><a href="../">Cats Effect Tutorial</a></li>
          <li class="level1 nav-node"><a href="../introduction/">Introduction</a></li>
          <li class="level2 nav-leaf"><a href="../introduction/clock.html">Clock</a></li>
          <li class="level1 active nav-node"><a href="#">Parallelism and Concurrency</a></li>
          <li class="level2 nav-leaf"><a href="coordination.html">Concurrent Coordination</a></li>
          <li class="level2 nav-leaf"><a href="job-manager.html">Job Manager</a></li>
        </ul>
    </nav>

    <div id="content">
        <main class="content">
            <h1 id="parallelism-and-concurrency" class="title">Parallelism and Concurrency</h1>
            <p>We will now start exploring one of the main effects that people use Cats Effect for: parallelism and concurrency.</p>
            <div class="exercise">
              
              <h4 id="exercise-parallelism-vs-concurrency">Exercise: Parallelism vs Concurrency</h4>
              <p>What&#39;s the difference between parallelism and concurrency?</p>
            </div>
            <div class="solution">
              <div class="solution-body">
                <p>Let&#39;s be clear on the difference between <strong>parallelism</strong> and <strong>concurrency</strong>:</p>
                <ul>
                  <li>
                    <p>Parallelism means multiple things running at the same time, even though we might not be able to see this. For example, <a href="https://en.wikipedia.org/wiki/Single_instruction,_multiple_data">SIMD</a> instructions on your CPU do multiple operations at the same time, but you cannot observe the intermediate results and hence cannot observe the parallelism. From the programmer&#39;s point of view you call the instruction on the CPU and get back the result.</p>
                  </li>
                  <li>
                    <p>Concurrency means we can observe multiple things happening in overlapping time periods, even though they might not actually be running at the same time (i.e. they might not be parallel.) An example is Javascript. It has a single-threaded runtime but we can still observe race conditions between different callback functions.</p>
                  </li>
                </ul>
              </div>
            </div>
            
            <h2 id="parallelism-in-cats-effect" class="section">Parallelism in Cats Effect</h2>
            <p>If we have two <code>IO</code> values that don&#39;t depend on each other, we should be able to run them in parallel.
            For example, the following two values could be run in parallel.</p>
            <pre><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">a</span><span> = </span><span class="type-name">IO</span><span>.</span><span class="identifier">println</span><span>(</span><span class="string-literal">&quot;A&quot;</span><span>)
</span><span class="keyword">val</span><span> </span><span class="identifier">b</span><span> = </span><span class="type-name">IO</span><span>.</span><span class="identifier">println</span><span>(</span><span class="string-literal">&quot;B&quot;</span><span>)</span></code></pre>
            <p>We know that <code>mapN</code> expresses a computation that depends on two independent <code>IO</code> values, but always runs them from left to right.</p>
            <pre><code class="nohighlight"><span>(</span><span class="identifier">a</span><span>, </span><span class="identifier">b</span><span>).</span><span class="identifier">mapN</span><span>((</span><span class="identifier">_</span><span>, </span><span class="identifier">_</span><span>) =&gt; </span><span class="string-literal">&quot;Done&quot;</span><span>).</span><span class="identifier">unsafeRunSync</span><span>()
</span><span class="comment">// A
// B</span></code></pre>
            <p>The reason for this is <strong>type class coherence</strong>, which is a fancy of way of saying &quot;if you can implement a type class in different ways, all those different ways should give the same result.&quot; To understand this we need to know what a type class is, the two type classes in use here (monad and applicative), and their relationship (monad can implement applicative.) This is out of scope for us here. If you want to know more, <em>Functional Programming Strategies</em> has the details.</p>
            <p>To get parallelism we can use <code>parMapN</code>. Try the following, and you should see <code>b</code> occasionally runs before <code>a</code>.</p>
            <pre><code class="nohighlight"><span>(</span><span class="identifier">a</span><span>, </span><span class="identifier">b</span><span>).</span><span class="identifier">parMapN</span><span>((</span><span class="identifier">_</span><span>, </span><span class="identifier">_</span><span>) =&gt; </span><span class="string-literal">&quot;Done&quot;</span><span>).</span><span class="identifier">unsafeRunSync</span><span>()</span></code></pre>
            <div class="exercise">
              
              <h4 id="exercise-parallelism-or-concurrency">Exercise: Parallelism or Concurrency?</h4>
              <p>Does <code>parMapN</code> display parallelism, concurrency, neither, or both?</p>
            </div>
            <div class="solution">
              <div class="solution-body">
                <p>It&#39;s both. It depends on the effects you run with <code>parMapN</code>, so it&#39;s not really a property of <code>parMapN</code> but of both <code>parMapN</code> and the effects that are being run.</p>
                <p>If the effects being run only compute values, so we have no way of observing they are doing stuff, then we have just parallelism. However, if we can observe them being run, as we can when we use <code>IO.println</code>, then we have concurrency.</p>
              </div>
            </div>
            <p>How does <code>parMap</code> work? It&#39;s either <em>dark magic</em> or an instance of the <a href="https://typelevel.org/cats/typeclasses/parallel.html">Parallel</a> type class. Despite it&#39;s name, <code>Parallel</code> is not about running code in parallel. It&#39;s just about having a different implementation of <code>mapN</code> and friends with different semantics. For <code>IO</code> these different semantics are, coincidently, about parallelism, but you can call <code>parMapN</code> on <code>Either</code> and get something else.</p>
            <div class="exercise">
              
              <h4 id="exercise-parallel-either">Exercise: Parallel Either</h4>
              <p>What does <code>parMapN</code> do on <code>Either</code>? Create some code examples illustrating the difference between the usual <code>mapN</code>.
              I suggest you use <code>List[String]</code> as the error type in the <code>Either</code>, and try calling <code>mapN</code> and <code>parMapN</code> when you have failed <code>Eithers</code> (i.e. two <code>Lefts</code>.)</p>
              <p>Note: you will need to <code>import cats.syntax.all.*</code> to make <code>mapN</code> etc. available.</p>
            </div>
            <div class="solution">
              <div class="solution-body">
                <p><code>parMapN</code> accumulates errors. Here&#39;s an example. Start by defining two failed <code>Eithers</code>.</p>
                <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">syntax</span><span>.</span><span class="identifier">all</span><span>.*

</span><span class="keyword">val</span><span> </span><span class="identifier">failed1</span><span>: </span><span class="type-name">Either</span><span>[</span><span class="type-name">List</span><span>[</span><span class="type-name">String</span><span>], </span><span class="type-name">Int</span><span>] = </span><span class="type-name">Left</span><span>(</span><span class="type-name">List</span><span>(</span><span class="string-literal">&quot;Oh no! I failed!&quot;</span><span>))
</span><span class="keyword">val</span><span> </span><span class="identifier">failed2</span><span>: </span><span class="type-name">Either</span><span>[</span><span class="type-name">List</span><span>[</span><span class="type-name">String</span><span>], </span><span class="type-name">Int</span><span>] = </span><span class="type-name">Left</span><span>(</span><span class="type-name">List</span><span>(</span><span class="string-literal">&quot;Oh no! I also failed!&quot;</span><span>))</span></code></pre>
                <p>Now let&#39;s see what happens when we use <code>mapN</code>.</p>
                <pre><code class="nohighlight"><span>(</span><span class="identifier">failed1</span><span>, </span><span class="identifier">failed2</span><span>).</span><span class="identifier">mapN</span><span>((</span><span class="identifier">a</span><span>, </span><span class="identifier">b</span><span>) =&gt; </span><span class="identifier">a</span><span> + </span><span class="identifier">b</span><span>)
</span><span class="comment">// res2: Either[List[String], Int] = Left(value = List(&quot;Oh no! I failed!&quot;))</span></code></pre>
                <p>We get only the first failure. </p>
                <p>Now we use <code>parMapN</code>.</p>
                <pre><code class="nohighlight"><span>(</span><span class="identifier">failed1</span><span>, </span><span class="identifier">failed2</span><span>).</span><span class="identifier">parMapN</span><span>((</span><span class="identifier">a</span><span>, </span><span class="identifier">b</span><span>) =&gt; </span><span class="identifier">a</span><span> + </span><span class="identifier">b</span><span>)
</span><span class="comment">// res3: Either[List[String], Int] = Left(
//   value = List(&quot;Oh no! I failed!&quot;, &quot;Oh no! I also failed!&quot;)
// )</span></code></pre>
                <p>We get <em>both</em> failures.</p>
              </div>
            </div>
            <div class="exercise">
              
              <h4 id="exercise-parallel-helpers">Exercise: Parallel Helpers</h4>
              <p>There are a bunch of <code>par</code> methods. Here are the most useful ones, with simplified type signatures.</p>
              <ul>
                <li><code>(F[A], ..., F[Z]).parTupled: F[(A, ..., Z)]</code></li>
                <li><code>(F[A], ..., F[Z]).parMapN((A, ..., Z) =&gt; AA): AA</code></li>
                <li><code>G[F[A]].parSequence: F[G[A]]</code></li>
                <li><code>G[A].parTraverse(A =&gt; F[B]): F[G[B]]</code></li>
              </ul>
              <p>Complete the challenge in <a href="https://github.com/creativescala/cats-effect-tutorial/blob/main/code/src/main/scala/parallelism/01-parallelism.scala"><code>code/src/main/scala/parallelism/01-parallelism.scala</code></a> to increase your familiarity with <code>parMapN</code> and friends.</p>
            </div>
            <div class="solution">
              <div class="solution-body">
                <ol class="arabic">
                  <li>
                    <p>This is simply <code>IO(Blackhold.consumeCPU(999999999L))</code></p>
                  </li>
                  <li>
                    <p><code>consume.timed</code> will run the blackhole and return the time it took. You probably want to out the time.</p>
                  </li>
                  <li>
                    <p>This is <code>mapN</code> versus <code>parMapN</code>.</p>
                  </li>
                  <li>
                    <p>This is <code>sequence</code> versus <code>parSequence</code>.</p>
                  </li>
                  <li>
                    <p>You can use <code>traverse</code> and <code>parTraverse</code> to achieve this.</p>
                  </li>
                </ol>
              </div>
            </div>
            <div class="exercise">
              
              <h4 id="exercise-job-manager">Exercise: Job Manager</h4>
              <p>Complete <a href="https://github.com/creativescala/cats-effect-tutorial/blob/main/code/src/main/scala/parallelism/02-job-manager.scala"><code>code/src/main/scala/parallelism/02-job-manager.scala</code></a> to use the tools in a somewhat realistic context.</p>
            </div>
            <div class="flex flex-row justify-between">
                <a class="pageNavigation" href="../introduction/clock.html">←Clock</a> <a class="pageNavigation" href="coordination.html">Concurrent Coordination→</a>
            </div>
        </main>
        <footer>Creative Scala is copyright Noel Welsh</footer>
    </div>

    </div>
</body>

</html>
